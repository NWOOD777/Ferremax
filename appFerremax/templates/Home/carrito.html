<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras - Ferremax</title>
    {% load static %}
    {% load cart_filters %}
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'CSS/carrito.css' %}">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f8f9fa;
            color: #212529;
            padding-top: 20px;
            padding-bottom: 100px;
        }
        
        .cart-header {
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 25px;
        }
        
        .cart-container {
            max-width: 1000px;
            margin: 40px auto;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            padding: 30px;
        }
        
        .cart-item {
            display: flex;
            align-items: center;
            padding: 20px;
            margin-bottom: 15px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        
        .cart-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .cart-item-image {
            width: 100px;
            height: 100px;
            margin-right: 25px;
            flex-shrink: 0;
        }
        
        .cart-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .no-image {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
            color: #999;
            font-size: 14px;
            border-radius: 8px;
        }
        
        .cart-item-details {
            flex-grow: 1;
        }
        
        .cart-item-details h3 {
            font-size: 18px;
            margin-bottom: 5px;
            color: #343a40;
        }
        
        .price {
            font-size: 16px;
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        .quantity-controls form {
            display: flex;
            align-items: center;
            max-width: 280px;
        }
        
        .quantity-input-group {
            width: 100%;
        }
        
        .quantity-controls input.qty-input {
            width: 60px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #ced4da;
            border-radius: 0;
            padding: 5px;
            background-color: white;
        }
        
        .quantity-controls .decrease-qty,
        .quantity-controls .increase-qty {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
            padding: 0;
            font-size: 14px;
        }
        
        .update-btn {
            background-color: #4C71AF;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-left: 8px;
        }
        
        .update-btn:hover {
            background-color: #395988;
        }
        
        .cart-item-subtotal {
            margin-left: 20px;
            text-align: right;
            font-weight: bold;
            font-size: 18px;
            color: #343a40;
            min-width: 100px;
        }
        
        .remove-item {
            position: absolute;
            top: 15px;
            right: 15px;
            color: #dc3545;
            text-decoration: none;
            font-size: 18px;
            font-weight: bold;
            transition: color 0.2s;
        }
        
        .remove-item:hover {
            color: #bd2130;
        }
        
        .empty-cart {
            text-align: center;
            padding: 50px 0;
        }
        
        .empty-cart p {
            font-size: 18px;
            color: #6c757d;
            margin-bottom: 20px;
        }
        
        .btn-continuar-comprando {
            display: inline-block;
            background-color: #4C71AF;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        .btn-continuar-comprando:hover {
            background-color: #395988;
            color: white;
        }
        
        .cart-summary {
            max-width: 1000px;
            margin: 0 auto 20px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            padding: 25px;
        }
        
        .total-block {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
            font-size: 18px;
        }
        
        .total-price {
            font-size: 24px;
            font-weight: bold;
            color: #343a40;
        }
        
        .paypal-block {
            padding-top: 10px;
        }
        
        .btn-return {
            display: inline-flex;
            align-items: center;
            background-color: #4C71AF;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            transition: background-color 0.2s;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .btn-return:hover {
            background-color: #395988;
            color: white;
        }
        
        .btn-return i {
            margin-right: 8px;
        }
        
        /* Estilos para el feedback de actualización */
        .quantity-input-group.update-success {
            transition: background-color 0.3s ease;
        }
        
        .update-spinner {
            color: #4C71AF;
        }
        
        /* Animación sutil de actualización */
        @keyframes updateSuccess {
            0% { background-color: rgba(25, 135, 84, 0); }
            50% { background-color: rgba(25, 135, 84, 0.15); }
            100% { background-color: rgba(25, 135, 84, 0); }
        }
        
        .update-animation {
            animation: updateSuccess 1s ease;
        }
        
        /* Estilos para el bloque de descuento */
        .discount-block {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #d1e7dd;
            border-color: #badbcc;
        }
        
        .discount-amount {
            font-weight: bold;
            font-size: 18px;
            color: #198754;
        }
        
        .total-after-discount {
            border-top: 1px dashed #ced4da;
            padding-top: 15px;
            margin-top: 5px;
        }
        
        .total-after-discount .total-price {
            color: #198754;
        }
        
        .discount-info {
            margin-bottom: 20px;
            color: #6c757d;
        }
        
        /* Estilos mejorados para advertencias de stock */
        .stock-warning {
            color: #664d03;
            font-weight: 500;
            background-color: #fff3cd;
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 3px solid #ffc107;
        }
        
        .badge.bg-warning {
            color: #664d03 !important; /* Aseguramos que el texto sea más oscuro y visible */
            font-weight: 600;
            background-color: #ffda6a !important; /* Un amarillo más brillante */
        }
    </style>
</head>

<body>
    <!-- CSRF Token para las solicitudes AJAX -->
    {% csrf_token %}
    
    <div class="container">
        <!-- Back button -->
        <a href="{% url 'index' %}" class="btn-return">
            <i class="fas fa-arrow-left"></i> Volver a la tienda
        </a>

        <div class="cart-container">
            <div class="cart-header">
                <h2 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Tu Carrito de Compras</h2>
            </div>
            
            {% if productos_problematicos %}
            <div class="alert mb-4" style="background-color: #fff3cd; border: 1px solid #ffecb5; border-left: 4px solid #ffc107; color: #664d03;">
                <h5 class="alert-heading" style="color: #664d03; font-weight: bold;"><i class="fas fa-exclamation-triangle me-2"></i>Advertencia de stock</h5>
                <p style="color: #664d03;">Se han detectado problemas con algunos productos en tu carrito:</p>
                <ul class="mb-0 ps-3" style="color: #664d03;">
                    {% for prod in productos_problematicos %}
                        {% if prod.tipo == 'negativo' %}
                        <li class="text-danger">
                            <strong>{{ prod.nombre }}</strong>: El producto tiene stock negativo ({{ prod.stock_actual }}). Por favor, contacta con soporte.
                        </li>
                        {% elif prod.tipo == 'insuficiente' %}
                        <li class="stock-warning">
                            <strong>{{ prod.nombre }}</strong>: Stock insuficiente. Solicitaste {{ prod.cantidad_solicitada }} unidades, pero solo hay {{ prod.stock_actual }} disponibles.
                        </li>
                        {% elif prod.tipo == 'no_existe' %}
                        <li class="text-danger">
                            <strong>{{ prod.nombre }}</strong>: Este producto ya no está disponible en el catálogo.
                        </li>
                        {% endif %}
                    {% endfor %}
                </ul>
                <hr style="border-color: #ffecb5;">
                <p class="mb-0" style="color: #664d03; font-weight: 500;"><i class="fas fa-info-circle me-1"></i> Te recomendamos ajustar las cantidades o eliminar los productos con problemas antes de proceder al pago.</p>
            </div>
            {% endif %}
            
            <div id="cart-items-container">
                {% if carrito %}
                    {% for item in carrito %}
                    <div class="cart-item {% if item.stock < 0 %}border-danger border-2{% elif item.stock < item.cantidad %}border-warning border-2{% endif %}">
                        <div class="cart-item-image">
                            {% if item.imagen %}
                            <img src="{{ item.imagen }}" alt="{{ item.nombre }}" class="shadow-sm">
                            {% else %}
                            <div class="no-image">
                                <i class="fas fa-image me-2"></i>Sin imagen
                            </div>
                            {% endif %}
                            
                            {% if item.stock < 0 %}
                            <span class="badge bg-danger position-absolute top-0 start-0 m-2 rounded-pill px-2">Stock negativo</span>
                            {% elif item.stock < item.cantidad %}
                            <span class="badge position-absolute top-0 start-0 m-2 rounded-pill px-2" style="background-color: #ffda6a; color: #664d03; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">Stock insuficiente</span>
                            {% endif %}
                        </div>
                        <div class="cart-item-details">
                            <h3>{{ item.nombre }}</h3>
                            <p class="price"><i class="fas fa-tag me-1"></i>${{ item.precio|floatformat:0 }} CLP</p>
                            {% if item.stock >= 0 %}
                            <small class="text-muted">Stock disponible: {{ item.stock }}</small>
                            {% else %}
                            <small class="text-danger">Stock: {{ item.stock }} (Contacta con soporte)</small>
                            {% endif %}
                            <div class="quantity-controls">
                                <div class="input-group quantity-input-group" data-product-id="{{ item.id }}" data-price="{{ item.precio }}">
                                    <button type="button" class="btn btn-outline-secondary decrease-qty" title="Disminuir cantidad">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" name="cantidad" value="{{ item.cantidad }}" min="1" class="form-control text-center qty-input" readonly>
                                    <button type="button" class="btn btn-outline-secondary increase-qty" title="Aumentar cantidad">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <div class="spinner-border text-primary update-spinner ms-2" role="status" style="display: none; width: 1.5rem; height: 1.5rem;">
                                        <span class="visually-hidden">Actualizando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="cart-item-subtotal">
                            <p>${{ item.precio|multiply:item.cantidad|floatformat:0 }} CLP</p>
                        </div>
                        <a href="{% url 'remove_from_cart' item.id %}" class="remove-item" title="Eliminar producto">
                            <i class="fas fa-times-circle"></i>
                        </a>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart fa-4x mb-3 text-muted"></i>
                        <p>Tu carrito está vacío</p>
                        <a href="{% url 'index' %}" class="btn-continuar-comprando">
                            <i class="fas fa-store me-1"></i> Continuar comprando
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        {% if carrito %}
        <div class="cart-summary">
            {% if apply_discount %}
            <div class="discount-block alert alert-success">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-tags me-2"></i>
                        <strong>¡Descuento del {{ discount_percentage }}%!</strong>
                        <p class="m-0 small">Descuento aplicado por tener {{ total_items }} productos</p>
                    </div>
                    <span class="discount-amount">
                        -${{ discount_amount|floatformat:0 }} CLP
                    </span>
                </div>
            </div>
            
            <div class="total-block total-after-discount">
                <span><i class="fas fa-money-bill-wave me-2"></i>Total:</span>
                <span class="total-price" id="totalPrice">
                    ${{ total_after_discount|floatformat:0 }} CLP
                </span>
            </div>
            {% else %}
            <div class="discount-info alert alert-light">
                <i class="fas fa-info-circle me-2"></i>
                <span>Compra 4 o más productos y obtén un 25% de descuento</span>
            </div>
            
            <div class="total-block">
                <span><i class="fas fa-money-bill-wave me-2"></i>Total:</span>
                <span class="total-price" id="totalPrice">
                    ${% if total %}{{ total|floatformat:0 }}{% else %}0{% endif %} CLP
                </span>
            </div>
            {% endif %}
            
            <div class="paypal-block">
                <div id="paypal-button-container"></div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Cargar el SDK de PayPal -->
    <script
        src="https://www.paypal.com/sdk/js?client-id=AeFSoG-iJHJs-MCOwSrrVCKL7kMOo5WhE7IH9YaI8Znlcp5xZt5tfGvucUV7zGEDMl4n4bnLSgP3KXHx&currency=USD"></script>

    <!-- Todo el código JavaScript en un solo bloque -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Carrito cargado desde la sesión de Django");
            
            // Configurar los botones de aumento y disminución de cantidad
            setupQuantityButtons();
            
            // Inicializar botones de PayPal con el carrito de sesión
            initPayPalButton();
        });
        
        // Función para configurar los botones de cantidad
        function setupQuantityButtons() {
            // Botones para aumentar cantidad
            document.querySelectorAll('.increase-qty').forEach(button => {
                button.addEventListener('click', function() {
                    const inputGroup = this.closest('.quantity-input-group');
                    const inputEl = inputGroup.querySelector('.qty-input');
                    const productId = inputGroup.dataset.productId;
                    let value = parseInt(inputEl.value);
                    
                    // Incrementar valor y actualizar en tiempo real
                    value += 1;
                    inputEl.value = value;
                    
                    // Actualizar carrito en el servidor
                    updateCartQuantity(productId, value, inputGroup);
                });
            });
            
            // Botones para disminuir cantidad
            document.querySelectorAll('.decrease-qty').forEach(button => {
                button.addEventListener('click', function() {
                    const inputGroup = this.closest('.quantity-input-group');
                    const inputEl = inputGroup.querySelector('.qty-input');
                    const productId = inputGroup.dataset.productId;
                    let value = parseInt(inputEl.value);
                    
                    if (value > 1) {
                        // Decrementar valor y actualizar en tiempo real
                        value -= 1;
                        inputEl.value = value;
                        
                        // Actualizar carrito en el servidor
                        updateCartQuantity(productId, value, inputGroup);
                    }
                });
            });
        }
        
        // Función para actualizar la cantidad del carrito en el servidor
        function updateCartQuantity(productId, quantity, inputGroup) {
            // Mostrar spinner de carga
            const spinner = inputGroup.querySelector('.update-spinner');
            spinner.style.display = 'inline-block';
            
            // Crear un FormData para enviar la solicitud
            const formData = new FormData();
            formData.append('cantidad', quantity);
            
            // Obtener el token CSRF
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Enviar solicitud al servidor para actualizar la cantidad
            fetch(`/agregar_al_carrito/${productId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'  // Identificar que es una solicitud AJAX
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al actualizar el carrito');
                }
                return response.json();
            })
            .then(data => {
                console.log('Respuesta del servidor:', data);
                // Check if success property exists and is false, otherwise proceed
                if (data.hasOwnProperty('success') && !data.success) {
                    throw new Error(data.error || 'Error al actualizar el carrito');
                }
                
                // Actualizar el subtotal
                const price = parseFloat(inputGroup.dataset.price);
                const subtotal = price * quantity;
                
                // Actualizar la cantidad en el input (por si el servidor devolvió un valor diferente)
                const inputEl = inputGroup.querySelector('.qty-input');
                inputEl.value = quantity;
                
                // Encontrar y actualizar el elemento de subtotal
                const cartItem = inputGroup.closest('.cart-item');
                const subtotalEl = cartItem.querySelector('.cart-item-subtotal p');
                subtotalEl.textContent = '$' + subtotal.toFixed(0) + ' CLP';
                
                // Actualizar el total general
                updateCartTotal();
                
                // Mostrar feedback visual de éxito
                showUpdateFeedback(inputGroup, 'success');
                
                // Log para confirmar la actualización
                console.log(`Producto ${productId} actualizado a ${quantity} unidades`);
            })
            .catch(error => {
                console.error('Error:', error);
                // Mostrar feedback visual de error
                showUpdateFeedback(inputGroup, 'error');
            })
            .finally(() => {
                // Ocultar spinner de carga después de un breve retraso
                setTimeout(() => {
                    spinner.style.display = 'none';
                }, 500);
            });
        }
        
        // Función para actualizar el total del carrito
        function updateCartTotal() {
            let total = 0;
            let totalItems = 0;
            
            // Calcular total y contar productos
            document.querySelectorAll('.cart-item').forEach(item => {
                const subtotalText = item.querySelector('.cart-item-subtotal p').textContent;
                // Improved price parsing to correctly handle all formats
                const subtotal = parseFloat(subtotalText.replace(/[^\d]/g, '')) || 0;
                const quantity = parseInt(item.querySelector('.qty-input').value) || 0;
                
                total += subtotal;
                totalItems += quantity;
            });
            
            // Aplicar descuento si hay 4 o más productos
            let discountAmount = 0;
            let totalAfterDiscount = total;
            
            if (totalItems >= 4) {
                discountAmount = total * 0.25; // 25% de descuento
                totalAfterDiscount = total - discountAmount;
                
                // Actualizar o crear elementos de descuento
                updateOrCreateDiscountElements(totalItems, discountAmount, totalAfterDiscount);
            } else {
                // Mostrar mensaje informativo sobre el descuento
                updateOrCreateInfoElement(total);
            }
        }
        
        // Función para actualizar o crear los elementos de descuento
        function updateOrCreateDiscountElements(totalItems, discountAmount, totalAfterDiscount) {
            const cartSummary = document.querySelector('.cart-summary');
            
            // Limpiar el contenido actual del cart-summary
            cartSummary.innerHTML = '';
            
            // Crear el bloque de descuento (asegurar que los valores son números)
            discountAmount = parseFloat(discountAmount) || 0;
            totalItems = parseInt(totalItems) || 0;
            
            const discountBlock = document.createElement('div');
            discountBlock.className = 'discount-block alert alert-success';
            discountBlock.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-tags me-2"></i>
                        <strong>¡Descuento del 25%!</strong>
                        <p class="m-0 small">Descuento aplicado por tener ${totalItems} productos</p>
                    </div>
                    <span class="discount-amount">
                        -$${Math.round(discountAmount)} CLP
                    </span>
                </div>
            `;
            
            // Agregar el bloque de descuento al resumen del carrito
            cartSummary.appendChild(discountBlock);
            
            // Crear el bloque de total con descuento (asegurar que el valor es un número)
            totalAfterDiscount = parseFloat(totalAfterDiscount) || 0;
            
            const totalAfterDiscountBlock = document.createElement('div');
            totalAfterDiscountBlock.className = 'total-block total-after-discount';
            totalAfterDiscountBlock.innerHTML = `
                <span><i class="fas fa-money-bill-wave me-2"></i>Total:</span>
                <span class="total-price" id="totalPrice">
                    $${Math.round(totalAfterDiscount)} CLP
                </span>
            `;
            
            // Agregar el bloque de total con descuento al resumen del carrito
            cartSummary.appendChild(totalAfterDiscountBlock);
            
            // Agregar el contenedor de PayPal
            const paypalBlock = document.createElement('div');
            paypalBlock.className = 'paypal-block';
            paypalBlock.innerHTML = '<div id="paypal-button-container"></div>';
            cartSummary.appendChild(paypalBlock);
            
            // Volver a inicializar el botón de PayPal
            if (typeof paypal !== 'undefined') {
                initPayPalButton();
            }
        }
        
        // Función para mostrar el mensaje informativo de descuento
        function updateOrCreateInfoElement(total) {
            const cartSummary = document.querySelector('.cart-summary');
            
            // Limpiar el contenido actual del cart-summary
            cartSummary.innerHTML = '';
            
            // Crear el mensaje informativo de descuento
            const discountInfo = document.createElement('div');
            discountInfo.className = 'discount-info alert alert-light';
            discountInfo.innerHTML = `
                <i class="fas fa-info-circle me-2"></i>
                <span>Compra 4 o más productos y obtén un 25% de descuento</span>
            `;
            
            // Agregar el mensaje informativo al resumen del carrito
            cartSummary.appendChild(discountInfo);
            
            // Crear el bloque de total normal (asegurar que el valor es un número)
            total = parseFloat(total) || 0;
            
            const totalBlock = document.createElement('div');
            totalBlock.className = 'total-block';
            totalBlock.innerHTML = `
                <span><i class="fas fa-money-bill-wave me-2"></i>Total:</span>
                <span class="total-price" id="totalPrice">
                    $${Math.round(total)} CLP
                </span>
            `;
            
            // Agregar el bloque de total al resumen del carrito
            cartSummary.appendChild(totalBlock);
            
            // Agregar el contenedor de PayPal
            const paypalBlock = document.createElement('div');
            paypalBlock.className = 'paypal-block';
            paypalBlock.innerHTML = '<div id="paypal-button-container"></div>';
            cartSummary.appendChild(paypalBlock);
            
            // Volver a inicializar el botón de PayPal
            if (typeof paypal !== 'undefined') {
                initPayPalButton();
            }
        }
        
        // Función para mostrar feedback visual de la actualización
        function showUpdateFeedback(inputGroup, status) {
            const originalBackground = inputGroup.style.background;
            
            if (status === 'success') {
                // Efecto visual sutil para indicar éxito
                inputGroup.style.background = 'rgba(25, 135, 84, 0.1)';
            } else {
                // Efecto visual para indicar error
                inputGroup.style.background = 'rgba(220, 53, 69, 0.1)';
            }
            
            // Restaurar el fondo original después de un momento
            setTimeout(() => {
                inputGroup.style.background = originalBackground;
            }, 1000);
        }

        // Configurar botón de PayPal
        function initPayPalButton() {
            paypal.Buttons({
                createOrder: function (data, actions) {
                    // Obtener el total final (que puede tener descuento)
                    const totalText = document.getElementById('totalPrice').textContent;
                    // Mejorado el parseo de precios para manejar cualquier formato
                    const total = parseFloat(totalText.replace(/[^\d]/g, '')) || 0;
                    
                    console.log('Monto a pagar:', total);
                    
                    // Asegurarse de que el valor sea al menos 1 USD para PayPal
                    const usdTotal = Math.max((total / 900), 1).toFixed(2);
                    console.log('Monto en USD:', usdTotal);
                    
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: usdTotal,
                                currency_code: 'USD'
                            },
                            description: "Carrito Ferremax"
                        }]
                    });
                },
                onApprove: function (data, actions) {
                    // Verificar primero si hay productos con problemas de stock
                    const productosProblematicos = {% if productos_problematicos %}true{% else %}false{% endif %};
                    
                    if (productosProblematicos) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'alert alert-danger mt-3';
                        errorDiv.innerHTML = `
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong>Error:</strong> No se puede procesar el pago porque hay productos con problemas de stock.
                            <hr>
                            <p class="mb-0">Por favor, revisa las advertencias de stock y ajusta tu carrito antes de continuar.</p>
                            <div class="mt-3">
                                <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">Recargar página</button>
                            </div>
                        `;
                        document.querySelector('.paypal-block').appendChild(errorDiv);
                        return Promise.reject(new Error('Stock issues detected'));
                    }
                    
                    return actions.order.capture().then(function (details) {
                        // Mostrar mensaje de procesando
                        const processingDiv = document.createElement('div');
                        processingDiv.className = 'alert alert-info mt-3';
                        processingDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando su pago...';
                        document.querySelector('.paypal-block').appendChild(processingDiv);
                        
                        // Construir el carrito para el backend
                        // Obtener los datos actualizados del carrito directamente desde la página
                        const cartItems = [];
                        
                        // Recorrer los elementos actuales del carrito en la página
                        document.querySelectorAll('.cart-item').forEach(item => {
                            const productId = item.querySelector('.quantity-input-group').dataset.productId;
                            const productName = item.querySelector('.cart-item-details h3').textContent;
                            const price = parseFloat(item.querySelector('.quantity-input-group').dataset.price);
                            const quantity = parseInt(item.querySelector('.qty-input').value);
                            const imgElement = item.querySelector('.cart-item-image img');
                            const imgSrc = imgElement ? imgElement.src : '';
                            
                            // Añadir al array con la cantidad correcta
                            cartItems.push({
                                id: productId,
                                nombre: productName,
                                price: price,
                                quantity: quantity,
                                img: imgSrc
                            });
                            
                            // Log para depurar
                            console.log(`Añadiendo producto: ${productName} (ID: ${productId}) - Cantidad: ${quantity}`);
                        });
                        
                        console.log('Datos del carrito a enviar:', JSON.stringify(cartItems, null, 2));
                        console.log('OrderID:', data.orderID);
                        console.log('PayerID:', details.payer.payer_id);
                        
                        // Verificar que las cantidades son correctas
                        let hasInvalidQuantity = false;
                        cartItems.forEach(item => {
                            if (!item.quantity || item.quantity < 1) {
                                console.error(`Producto ${item.id} (${item.nombre}) tiene cantidad inválida: ${item.quantity}`);
                                hasInvalidQuantity = true;
                            }
                        });
                        
                        // Mostrar resumen antes de enviar
                        console.log("Resumen de compra antes de procesar:");
                        cartItems.forEach(item => {
                            console.log(`- ${item.nombre}: ${item.quantity} unidades a $${item.price} c/u = $${item.price * item.quantity}`);
                        });
                        
                        // Asegurarnos de que cada item del carrito tenga los datos necesarios
                        if (!cartItems.length || hasInvalidQuantity) {
                            // Si no hay ítems o hay cantidades inválidas, mostrar error
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'alert alert-danger mt-3';
                            errorDiv.innerHTML = `
                                <i class="fas fa-exclamation-circle me-2"></i>
                                <strong>Error:</strong> ${hasInvalidQuantity ? 'Se detectaron cantidades inválidas en el carrito.' : 'No hay productos en el carrito para procesar.'}
                                <hr>
                                <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">Recargar página</button>
                            `;
                            document.querySelector('.paypal-block').appendChild(errorDiv);
                            if (processingDiv) processingDiv.remove();
                            return;
                        }
                        
                        fetch('/ejecutar_pago_ajax/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({
                                cart: cartItems,
                                payment_id: data.orderID,
                                payer_id: details.payer.payer_id
                            })
                        })
                        .then(response => {
                            console.log("Respuesta recibida:", response.status);
                            if (!response.ok) {
                                return response.json().then(errorData => {
                                    throw new Error(JSON.stringify(errorData));
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log("Datos recibidos:", data);
                            // Remover el mensaje de procesando
                            if (processingDiv) processingDiv.remove();
                            
                            // Registrar los datos del carrito procesado
                            console.log("Carrito procesado correctamente:", cartItems);
                            
                            if (data.success) {
                                // Mostrar mensaje de éxito
                                const cartContainer = document.querySelector('.cart-container');
                                const successDiv = document.createElement('div');
                                successDiv.className = 'alert alert-success mt-3 p-4 text-center';
                                successDiv.style.fontSize = '1.2rem';
                                successDiv.innerHTML = `
                                    <i class="fas fa-check-circle fa-2x mb-3 text-success"></i>
                                    <h4 class="alert-heading mb-3">¡Pago procesado con éxito!</h4>
                                    <p>Su pedido #${data.pedido_id} ha sido registrado correctamente.</p>
                                    <p class="mb-0">Redirigiendo a Mis Pedidos...</p>
                                    <div class="progress mt-3">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%" id="redirect-progress"></div>
                                    </div>
                                `;
                                
                                // Reemplazar el contenido del carrito con el mensaje de éxito
                                cartContainer.innerHTML = '';
                                cartContainer.appendChild(successDiv);
                                
                                // Remover el resumen del carrito ya que no es necesario
                                const cartSummary = document.querySelector('.cart-summary');
                                if (cartSummary) cartSummary.remove();
                                
                                // Animación de progreso
                                const progressBar = document.getElementById('redirect-progress');
                                let progress = 0;
                                const progressInterval = setInterval(() => {
                                    progress += 2;
                                    progressBar.style.width = progress + '%';
                                    if (progress >= 100) clearInterval(progressInterval);
                                }, 40); // 2 segundos en total
                                
                                // Redirigir a la página de confirmación del pedido
                                setTimeout(() => {
                                    // Usar la URL de redirección proporcionada por el servidor si existe
                                    const redirectUrl = data.redirect_url || '/mis_pedidos/';
                                    window.location.href = redirectUrl;
                                }, 2000);
                            } else {
                                // Mostrar mensaje de error con detalles del servidor
                                const errorDiv = document.createElement('div');
                                errorDiv.className = 'alert alert-danger mt-3';
                                errorDiv.innerHTML = `
                                    <i class="fas fa-exclamation-circle me-2"></i>
                                    <strong>Error:</strong> ${data.error || 'Error desconocido'}
                                    <hr>
                                    <p class="mb-0">Por favor verifique su sesión e intente nuevamente.</p>
                                    <div class="mt-2">
                                        <button class="btn btn-outline-secondary btn-sm me-2" onclick="location.reload()">Recargar página</button>
                                        <a href="{% url 'index' %}" class="btn btn-outline-primary btn-sm">Volver a productos</a>
                                    </div>
                                `;
                                document.querySelector('.paypal-block').appendChild(errorDiv);
                            }
                        })
                        .catch(error => {
                            console.error('Error al procesar el pago:', error);
                            // Remover el mensaje de procesando si existe
                            if (processingDiv) processingDiv.remove();
                            
                            // Intentar obtener una respuesta detallada si es posible
                            let errorMessage = 'Error al procesar el pago. Por favor, inténtelo de nuevo más tarde.';
                            
                            try {
                                // Intentar extraer el mensaje de error más detallado
                                if (error.message) {
                                    const errorData = JSON.parse(error.message);
                                    if (errorData && errorData.error) {
                                        errorMessage = errorData.error;
                                    }
                                }
                            } catch (e) {
                                console.log('Error al analizar el mensaje de error:', e);
                            }
                            
                            // Mostrar mensaje de error
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'alert alert-danger mt-3';
                            errorDiv.innerHTML = `
                                <i class="fas fa-exclamation-circle me-2"></i>
                                <strong>Error de pago:</strong> ${errorMessage}
                                <hr>
                                <p class="mb-0">Si el problema persiste, por favor contacte con soporte o intente con otro método de pago.</p>
                                <div class="mt-2">
                                    <button class="btn btn-outline-danger btn-sm me-2" onclick="location.reload()">Reintentar</button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="window.location.href='{% url 'index' %}'">Volver a la tienda</button>
                                </div>
                            `;
                            document.querySelector('.paypal-block').appendChild(errorDiv);
                            
                            // Mostrar información de depuración en la consola
                            console.log('Datos del carrito:', cartItems);
                            console.log('OrderID:', data.orderID);
                            console.log('PayerID:', details.payer.payer_id);
                        });
                    });
                }
            }).render('#paypal-button-container');
        }
    </script>
</body>

</html>